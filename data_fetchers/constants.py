import os
import pyarrow as pa

from pathlib import Path

# Data storage paths
ENSTOE_BASE_DATA_DIR = Path(os.getenv("ENTSOE_DATA_DIR", "data/entsoe_curves"))
ENSTOE_BASE_DATA_DIR.mkdir(parents=True, exist_ok=True)

ENERGINET_BASE_DATA_DIR = Path(os.getenv("ENERGINET_DATA_DIR", "data/energinet_curves"))
ENERGINET_BASE_DATA_DIR.mkdir(parents=True, exist_ok=True)

# Retry settings
WRITE_RETRY_SECONDS = 2
MAX_RETRIES = 3

# Curve schema
CURVE_SCHEMA = pa.schema(
    [
        ("market", pa.string()),
        ("curve_type", pa.string()),
        ("neighbour", pa.string()),  # for flows
        ("production_type", pa.string()),  # for generation mix
        ("timestamp", pa.timestamp("us", tz="UTC")),
        ("value", pa.float64()),
        ("resolution", pa.string()),
        ("unit", pa.string()),
        ("source", pa.string()),
        ("year", pa.int32()),
        ("month", pa.int32()),
        ("day", pa.int32()),
    ]
)

BALANCING_CURVE_SCHEMA = pa.schema(
    [
        ("market", pa.string()),
        ("curve_type", pa.string()),
        ("timestamp", pa.timestamp("us", tz="UTC")),
        ("value", pa.float64()),  # EUR / MWh
        ("balancing_demand", pa.float64()),  # MW
        ("direction", pa.int64()),
        # Automatic frequency restoration reserves
        ("aFRR_up", pa.float64()),  # MWh
        ("aFRR_up_vwa", pa.float64()),  # EUR / MWh
        ("aFRR_down", pa.float64()),  # MWh
        ("aFRR_down_vwa", pa.float64()),  # EUR / MWh
        # Manual frequency restoration reserves
        ("mFRR_marginal_price_up", pa.float64()),  # EUR / MWh
        ("mFRR_marginal_price_down", pa.float64()),  # EUR / MWh
        ("resolution", pa.string()),
        ("source", pa.string()),
        ("year", pa.int32()),
        ("month", pa.int32()),
        ("day", pa.int32()),
    ]
)

ENTSOE_CODES_TO_ZONES = {
    "10YDE-VE-------2": "DE_50HZ",
    "10YAL-KESH-----5": "AL",
    "10YDE-RWENET---I": "DE_AMPRION",
    "10YAT-APG------L": "AT",
    "10Y1001A1001A51S": "BY",
    "10YBE----------2": "BE",
    "10YBA-JPCC-----D": "BA",
    "10YCA-BULGARIA-R": "BG",
    "10YDOM-CZ-DE-SKK": "CZ_DE_SK",
    "10YHR-HEP------M": "HR",
    "10YDOM-REGION-1V": "CWE",
    "10YCY-1001A0003J": "CY",
    "10YCZ-CEPS-----N": "CZ",
    "10Y1001A1001A63L": "DE_AT_LU",
    "10Y1001A1001A82H": "DE_LU",
    "10Y1001A1001A65H": "DK",
    "10YDK-1--------W": "DK_1",
    "46Y000000000007M": "DK_1_NO_1",
    "10YDK-2--------M": "DK_2",
    "10Y1001A1001A796": "DK_CA",
    "10Y1001A1001A39I": "EE",
    "10YFI-1--------U": "FI",
    "10YMK-MEPSO----8": "MK",
    "10YFR-RTE------C": "FR",
    "10Y1001A1001A83F": "DE",
    "10YGR-HTSO-----Y": "GR",
    "10YHU-MAVIR----U": "HU",
    "IS": "IS",
    "10Y1001A1001A59C": "IE_SEM",
    "10YIE-1001A00010": "IE",
    "10YIT-GRTN-----B": "IT",
    "10Y1001A1001A885": "IT_SACO_AC",
    "10Y1001C--00096J": "IT_CALA",
    "10Y1001A1001A893": "IT_SACO_DC",
    "10Y1001A1001A699": "IT_BRNN",
    "10Y1001A1001A70O": "IT_CNOR",
    "10Y1001A1001A71M": "IT_CSUD",
    "10Y1001A1001A72K": "IT_FOGN",
    "10Y1001A1001A66F": "IT_GR",
    "10Y1001A1001A84D": "IT_MACRO_NORTH",
    "10Y1001A1001A85B": "IT_MACRO_SOUTH",
    "10Y1001A1001A877": "IT_MALTA",
    "10Y1001A1001A73I": "IT_NORD",
    "10Y1001A1001A80L": "IT_NORD_AT",
    "10Y1001A1001A68B": "IT_NORD_CH",
    "10Y1001A1001A81J": "IT_NORD_FR",
    "10Y1001A1001A67D": "IT_NORD_SI",
    "10Y1001A1001A76C": "IT_PRGP",
    "10Y1001A1001A77A": "IT_ROSN",
    "10Y1001A1001A74G": "IT_SARD",
    "10Y1001A1001A75E": "IT_SICI",
    "10Y1001A1001A788": "IT_SUD",
    "10Y1001A1001A50U": "RU_KGD",
    "10YLV-1001A00074": "LV",
    "10YLT-1001A0008Q": "LT",
    "10YLU-CEGEDEL-NQ": "LU",
    "10Y1001A1001A82H": "LU_BZN",
    "10Y1001A1001A93C": "MT",
    "10YCS-CG-TSO---S": "ME",
    "10YGB----------A": "GB",
    "10Y1001A1001B012": "GE",
    "10Y1001C--00098F": "GB_IFA",
    "17Y0000009369493": "GB_IFA2",
    "11Y0-0000-0265-K": "GB_ELECLINK",
    "10Y1001A1001A92E": "UK",
    "10YNL----------L": "NL",
    "10YNO-1--------2": "NO_1",
    "10Y1001A1001A64J": "NO_1A",
    "10YNO-2--------T": "NO_2",
    "50Y0JVU59B4JWQCU": "NO_2_NSL",
    "10Y1001C--001219": "NO_2A",
    "10YNO-3--------J": "NO_3",
    "10YNO-4--------9": "NO_4",
    "10Y1001A1001A48H": "NO_5",
    "10YNO-0--------C": "NO",
    "10YDOM-1001A082L": "PL_CZ",
    "10YPL-AREA-----S": "PL",
    "10YPT-REN------W": "PT",
    "10Y1001A1001A990": "MD",
    "10YRO-TEL------P": "RO",
    "10Y1001A1001A49F": "RU",
    "10Y1001A1001A44P": "SE_1",
    "10Y1001A1001A45N": "SE_2",
    "10Y1001A1001A46L": "SE_3",
    "10Y1001A1001A47J": "SE_4",
    "10YCS-SERBIATSOV": "RS",
    "10YSK-SEPS-----K": "SK",
    "10YSI-ELES-----O": "SI",
    "10Y1001A1001A016": "GB_NIR",
    "10YES-REE------0": "ES",
    "10YSE-1--------K": "SE",
    "10YCH-SWISSGRIDZ": "CH",
    "10YDE-EON------1": "DE_TENNET",
    "10YDE-ENBW-----N": "DE_TRANSNET",
    "10YTR-TEIAS----W": "TR",
    "10Y1001C--00003F": "UA",
    "10Y1001A1001A869": "UA_DOBTPP",
    "10YUA-WEPS-----0": "UA_BEI",
    "10Y1001C--000182": "UA_IPS",
    "10Y1001C--00100H": "XK",
    "10Y1001C--00002H": "DE_AMP_LU",
}

ENTSOE_ZONES_TO_CODES = {
    "DE_50HZ": "10YDE-VE-------2",
    "AL": "10YAL-KESH-----5",
    "DE_AMPRION": "10YDE-RWENET---I",
    "AT": "10YAT-APG------L",
    "BY": "10Y1001A1001A51S",
    "BE": "10YBE----------2",
    "BA": "10YBA-JPCC-----D",
    "BG": "10YCA-BULGARIA-R",
    "CZ_DE_SK": "10YDOM-CZ-DE-SKK",
    "HR": "10YHR-HEP------M",
    "CWE": "10YDOM-REGION-1V",
    "CY": "10YCY-1001A0003J",
    "CZ": "10YCZ-CEPS-----N",
    "DE_AT_LU": "10Y1001A1001A63L",
    "LU_BZN": "10Y1001A1001A82H",
    "DK": "10Y1001A1001A65H",
    "DK_1": "10YDK-1--------W",
    "DK_1_NO_1": "46Y000000000007M",
    "DK_2": "10YDK-2--------M",
    "DK_CA": "10Y1001A1001A796",
    "EE": "10Y1001A1001A39I",
    "FI": "10YFI-1--------U",
    "MK": "10YMK-MEPSO----8",
    "FR": "10YFR-RTE------C",
    "DE": "10Y1001A1001A83F",
    "GR": "10YGR-HTSO-----Y",
    "HU": "10YHU-MAVIR----U",
    "IS": "IS",
    "IE_SEM": "10Y1001A1001A59C",
    "IE": "10YIE-1001A00010",
    "IT": "10YIT-GRTN-----B",
    "IT_SACO_AC": "10Y1001A1001A885",
    "IT_CALA": "10Y1001C--00096J",
    "IT_SACO_DC": "10Y1001A1001A893",
    "IT_BRNN": "10Y1001A1001A699",
    "IT_CNOR": "10Y1001A1001A70O",
    "IT_CSUD": "10Y1001A1001A71M",
    "IT_FOGN": "10Y1001A1001A72K",
    "IT_GR": "10Y1001A1001A66F",
    "IT_MACRO_NORTH": "10Y1001A1001A84D",
    "IT_MACRO_SOUTH": "10Y1001A1001A85B",
    "IT_MALTA": "10Y1001A1001A877",
    "IT_NORD": "10Y1001A1001A73I",
    "IT_NORD_AT": "10Y1001A1001A80L",
    "IT_NORD_CH": "10Y1001A1001A68B",
    "IT_NORD_FR": "10Y1001A1001A81J",
    "IT_NORD_SI": "10Y1001A1001A67D",
    "IT_PRGP": "10Y1001A1001A76C",
    "IT_ROSN": "10Y1001A1001A77A",
    "IT_SARD": "10Y1001A1001A74G",
    "IT_SICI": "10Y1001A1001A75E",
    "IT_SUD": "10Y1001A1001A788",
    "RU_KGD": "10Y1001A1001A50U",
    "LV": "10YLV-1001A00074",
    "LT": "10YLT-1001A0008Q",
    "LU": "10YLU-CEGEDEL-NQ",
    "MT": "10Y1001A1001A93C",
    "ME": "10YCS-CG-TSO---S",
    "GB": "10YGB----------A",
    "GE": "10Y1001A1001B012",
    "GB_IFA": "10Y1001C--00098F",
    "GB_IFA2": "17Y0000009369493",
    "GB_ELECLINK": "11Y0-0000-0265-K",
    "UK": "10Y1001A1001A92E",
    "NL": "10YNL----------L",
    "NO_1": "10YNO-1--------2",
    "NO_1A": "10Y1001A1001A64J",
    "NO_2": "10YNO-2--------T",
    "NO_2_NSL": "50Y0JVU59B4JWQCU",
    "NO_2A": "10Y1001C--001219",
    "NO_3": "10YNO-3--------J",
    "NO_4": "10YNO-4--------9",
    "NO_5": "10Y1001A1001A48H",
    "NO": "10YNO-0--------C",
    "PL_CZ": "10YDOM-1001A082L",
    "PL": "10YPL-AREA-----S",
    "PT": "10YPT-REN------W",
    "MD": "10Y1001A1001A990",
    "RO": "10YRO-TEL------P",
    "RU": "10Y1001A1001A49F",
    "SE_1": "10Y1001A1001A44P",
    "SE_2": "10Y1001A1001A45N",
    "SE_3": "10Y1001A1001A46L",
    "SE_4": "10Y1001A1001A47J",
    "RS": "10YCS-SERBIATSOV",
    "SK": "10YSK-SEPS-----K",
    "SI": "10YSI-ELES-----O",
    "GB_NIR": "10Y1001A1001A016",
    "ES": "10YES-REE------0",
    "SE": "10YSE-1--------K",
    "CH": "10YCH-SWISSGRIDZ",
    "DE_TENNET": "10YDE-EON------1",
    "DE_TRANSNET": "10YDE-ENBW-----N",
    "TR": "10YTR-TEIAS----W",
    "UA": "10Y1001C--00003F",
    "UA_DOBTPP": "10Y1001A1001A869",
    "UA_BEI": "10YUA-WEPS-----0",
    "UA_IPS": "10Y1001C--000182",
    "XK": "10Y1001C--00100H",
    "DE_AMP_LU": "10Y1001C--00002H",
}


NEIGHBOURS = {
    "BE": ["NL", "DE_AT_LU", "FR", "GB", "DE_LU"],
    "NL": ["BE", "DE_AT_LU", "DE_LU", "GB", "NO_2", "DK_1"],
    "DE_AT_LU": [
        "BE",
        "CH",
        "CZ",
        "DK_1",
        "DK_2",
        "FR",
        "IT_NORD",
        "IT_NORD_AT",
        "NL",
        "PL",
        "SE_4",
        "SI",
    ],
    "FR": ["BE", "CH", "DE_AT_LU", "DE_LU", "ES", "GB", "IT_NORD", "IT_NORD_FR"],
    "CH": ["AT", "DE_AT_LU", "DE_LU", "FR", "IT_NORD", "IT_NORD_CH"],
    "AT": ["CH", "CZ", "DE_LU", "HU", "IT_NORD", "SI"],
    "CZ": ["AT", "DE_AT_LU", "DE_LU", "PL", "SK"],
    "GB": ["BE", "FR", "IE_SEM", "NL", "NO_2", "DK_1"],
    "NO_2": ["DE_LU", "DK_1", "NL", "NO_1", "NO_5", "GB"],
    "HU": ["AT", "HR", "RO", "RS", "SI", "SK", "UA"],
    "IT_NORD": ["CH", "DE_AT_LU", "FR", "SI", "AT", "IT_CNOR"],
    "ES": ["FR", "PT"],
    "SI": ["AT", "DE_AT_LU", "HR", "IT_NORD", "HU"],
    "RS": ["AL", "BA", "BG", "HR", "HU", "ME", "MK", "RO"],
    "PL": ["CZ", "DE_AT_LU", "DE_LU", "LT", "SE_4", "SK", "UA"],
    "ME": ["AL", "BA", "RS"],
    "DK_1": ["DE_AT_LU", "DE_LU", "DK_2", "NO_2", "SE_3", "NL", "GB"],
    "RO": ["BG", "HU", "RS", "UA"],
    "LT": ["BY", "LV", "PL", "RU_KGD", "SE_4"],
    "BG": ["GR", "MK", "RO", "RS", "TR"],
    "SE_3": ["DK_1", "FI", "NO_1", "SE_2", "SE_4"],
    "LV": ["EE", "LT", "RU"],
    "IE_SEM": ["GB"],
    "BA": ["HR", "ME", "RS"],
    "NO_1": ["NO_2", "NO_3", "NO_5", "SE_3"],
    "SE_4": ["DE_AT_LU", "DE_LU", "DK_2", "LT", "PL", "SE_3"],
    "NO_5": ["NO_1", "NO_2", "NO_3"],
    "SK": ["CZ", "HU", "PL", "UA"],
    "EE": ["FI", "LV", "RU"],
    "DK_2": ["DE_AT_LU", "DE_LU", "DK_1", "SE_4"],
    "FI": ["EE", "NO_4", "RU", "SE_1", "SE_3"],
    "NO_4": ["SE_2", "FI", "NO_3", "SE_1"],
    "SE_1": ["FI", "NO_4", "SE_2"],
    "SE_2": ["NO_3", "NO_4", "SE_1", "SE_3"],
    "DE_LU": ["AT", "BE", "CH", "CZ", "DK_1", "DK_2", "FR", "NO_2", "NL", "PL", "SE_4"],
    "MK": ["BG", "GR", "RS"],
    "PT": ["ES"],
    "GR": ["AL", "BG", "IT_BRNN", "IT_GR", "MK", "TR"],
    "NO_3": ["NO_1", "NO_4", "NO_5", "SE_2"],
    "IT": ["AT", "FR", "GR", "MT", "ME", "SI", "CH"],
    "IT_BRNN": ["GR", "IT_SUD"],
    "IT_SUD": ["IT_BRNN", "IT_CSUD", "IT_FOGN", "IT_ROSN", "IT_CALA"],
    "IT_FOGN": ["IT_SUD"],
    "IT_ROSN": ["IT_SICI", "IT_SUD"],
    "IT_CSUD": ["IT_CNOR", "IT_SARD", "IT_SUD"],
    "IT_CNOR": ["IT_NORD", "IT_CSUD", "IT_SARD"],
    "IT_SARD": ["IT_CNOR", "IT_CSUD"],
    "IT_SICI": ["IT_CALA", "IT_ROSN", "MT"],
    "IT_CALA": ["IT_SICI", "IT_SUD"],
    "MT": ["IT_SICI"],
    "HR": ["BA", "HU", "RS", "SI"],
}

ZONES = [
    "BE",
    "NL",
    "DE_AT_LU",
    "FR",
    "CH",
    "AT",
    "CZ",
    "GB",
    "NO_2",
    "HU",
    "IT_NORD",
    "ES",
    "SI",
    "RS",
    "PL",
    "ME",
    "DK_1",
    "RO",
    "LT",
    "BG",
    "SE_3",
    "LV",
    "IE_SEM",
    "BA",
    "NO_1",
    "SE_4",
    "NO_5",
    "SK",
    "EE",
    "DK_2",
    "FI",
    "NO_4",
    "SE_1",
    "SE_2",
    "DE_LU",
    "MK",
    "PT",
    "GR",
    "NO_3",
    "IT",
    "IT_BRNN",
    "IT_SUD",
    "IT_FOGN",
    "IT_ROSN",
    "IT_CSUD",
    "IT_CNOR",
    "IT_SARD",
    "IT_SICI",
    "IT_CALA",
    "MT",
    "HR",
]

FREQUENCIES = {"PT60M": "h", "PT15M": "15min", "PT30M": "30min"}
